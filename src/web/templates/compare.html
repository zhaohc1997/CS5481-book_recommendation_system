{% extends "base.html" %}

{% block title %}æ¨¡å‹å¯¹æ¯” - æ™ºèƒ½å›¾ä¹¦æ¨èç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="text-center mb-5">
        <h1 class="display-4 fw-bold mb-3">
            <i class="fas fa-chart-bar me-2"></i>
            æ¨¡å‹æ€§èƒ½å¯¹æ¯”
        </h1>
        <p class="lead text-muted">
            åŒæ—¶å¯¹æ¯”å¤šä¸ªæ¨èæ¨¡å‹çš„æ•ˆæœï¼Œç›´è§‚æ„Ÿå—ä¸åŒç®—æ³•çš„å·®å¼‚
        </p>
    </div>
    
    <!-- æœç´¢æ¡† -->
    <div class="row justify-content-center mb-5">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-body p-4">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-search me-2"></i>è¾“å…¥å›¾ä¹¦æ ‡é¢˜
                    </h5>
                    
                    <!-- çƒ­é—¨å›¾ä¹¦å¿«æ·é€‰æ‹© -->
                    <div class="mb-3">
                        <small class="text-muted d-block mb-2">ğŸ’¡ å¿«æ·é€‰æ‹©çƒ­é—¨å›¾ä¹¦:</small>
                        <div class="d-flex flex-wrap gap-2" id="popularBooksContainer">
                            {% for book in popular_books %}
                            <button class="btn btn-sm btn-outline-primary popular-book-btn" 
                                    type="button"
                                    data-book-title="{{ book }}">
                                {{ book[:50] }}{% if book|length > 50 %}...{% endif %}
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div class="input-group input-group-lg mb-3">
                        <input type="text" class="form-control search-box" 
                               id="compareQuery" 
                               placeholder="è¾“å…¥å®Œæ•´æˆ–éƒ¨åˆ†å›¾ä¹¦æ ‡é¢˜..."
                               onkeypress="if(event.key==='Enter') compareModels()">
                        <button class="btn btn-primary px-4" type="button" onclick="compareModels()">
                            <i class="fas fa-play me-2"></i>å¼€å§‹å¯¹æ¯”
                        </button>
                    </div>
                    <div class="form-text">
                        <i class="fas fa-info-circle me-1"></i>
                        ç³»ç»Ÿå°†ä½¿ç”¨ {{ models|length }} ä¸ªæ¨¡å‹åŒæ—¶ç”Ÿæˆæ¨èç»“æœã€‚æ”¯æŒæ¨¡ç³ŠåŒ¹é…ï¼
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
    <div id="loadingSection" style="display: none;" class="text-center py-5">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">æ­£åœ¨ç”Ÿæˆæ¨è...</p>
    </div>
    
    <!-- å¯¹æ¯”ç»“æœ -->
    <div id="comparisonResults"></div>
</div>

<script>
// é¡µé¢åŠ è½½å®Œæˆåç»‘å®šäº‹ä»¶
document.addEventListener('DOMContentLoaded', function() {
    // ä¸ºæ‰€æœ‰å¿«æ·æŒ‰é’®ç»‘å®šç‚¹å‡»äº‹ä»¶
    document.querySelectorAll('.popular-book-btn').forEach(function(button) {
        button.addEventListener('click', function() {
            const bookTitle = this.getAttribute('data-book-title');
            selectBook(bookTitle);
        });
    });
});

function selectBook(title) {
    console.log('é€‰æ‹©å›¾ä¹¦:', title);
    document.getElementById('compareQuery').value = title;
    compareModels();
}

function compareModels() {
    const query = document.getElementById('compareQuery').value.trim();
    
    console.log('å¼€å§‹å¯¹æ¯”ï¼ŒæŸ¥è¯¢:', query);
    
    if (!query) {
        alert('è¯·è¾“å…¥å›¾ä¹¦æ ‡é¢˜');
        return;
    }
    
    const loadingSection = document.getElementById('loadingSection');
    const resultsSection = document.getElementById('comparisonResults');
    
    loadingSection.style.display = 'block';
    resultsSection.innerHTML = '';
    
    fetch('/api/compare', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            book_title: query,
            n: 5
        })
    })
    .then(response => {
        console.log('å“åº”çŠ¶æ€:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('å“åº”æ•°æ®:', data);
        loadingSection.style.display = 'none';
        
        if (data.success) {
            displayComparison(data);
        } else {
            let errorHtml = `
                <div class="alert alert-warning">
                    <h5><i class="fas fa-exclamation-triangle me-2"></i>æœªæ‰¾åˆ°å›¾ä¹¦</h5>
                    <p class="mb-2">æœªæ‰¾åˆ° "${query}"ï¼Œæ‚¨å¯ä»¥å°è¯•:</p>
            `;
            
            if (data.suggestions && data.suggestions.length > 0) {
                errorHtml += '<div class="d-flex flex-wrap gap-2 mt-3">';
                data.suggestions.forEach(title => {
                    errorHtml += `
                        <button class="btn btn-sm btn-primary" 
                                onclick="selectBook(\`${title.replace(/`/g, '\\`')}\`)">
                            ${title.substring(0, 50)}${title.length > 50 ? '...' : ''}
                        </button>
                    `;
                });
                errorHtml += '</div>';
            }
            
            errorHtml += '</div>';
            resultsSection.innerHTML = errorHtml;
        }
    })
    .catch(error => {
        console.error('è¯·æ±‚é”™è¯¯:', error);
        loadingSection.style.display = 'none';
        resultsSection.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-times-circle me-2"></i>
                è¯·æ±‚å¤±è´¥: ${error.message}
            </div>
        `;
    });
}

function displayComparison(data) {
    const resultsSection = document.getElementById('comparisonResults');
    
    console.log('æ˜¾ç¤ºå¯¹æ¯”ç»“æœ:', data);
    
    let html = `
        <div class="mb-4">
            <h3 class="fw-bold">
                <i class="fas fa-book me-2"></i>
                æŸ¥è¯¢å›¾ä¹¦: <span class="text-primary">${escapeHtml(data.actual_title)}</span>
            </h3>
    `;
    
    if (!data.is_exact_match && data.query !== data.actual_title) {
        html += `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                æ‚¨è¾“å…¥çš„ "<strong>${escapeHtml(data.query)}</strong>" å·²è‡ªåŠ¨åŒ¹é…åˆ° "<strong>${escapeHtml(data.actual_title)}</strong>"
            </div>
        `;
    }
    
    html += `</div>`;
    
    const modelNames = Object.keys(data.results);
    const modelColors = {
        'ItemBasedCF': '#6366f1',
        'MatrixFactorization': '#f59e0b',
        'LightFM': '#8b5cf6',
        'TwoStage': '#ec4899'
    };
    
    modelNames.forEach((modelName) => {
        const modelResult = data.results[modelName];
        const color = modelColors[modelName] || '#64748b';
        
        html += `
            <div class="card mb-4 border-0 shadow-sm">
                <div class="card-header" style="background: linear-gradient(135deg, ${color} 0%, ${color}dd 100%); color: white;">
                    <h5 class="mb-0">
                        <i class="fas fa-robot me-2"></i>
                        ${modelName}
                        ${modelName === 'TwoStage' ? '<span class="badge bg-warning text-dark ms-2">æœ€ä½³</span>' : ''}
                    </h5>
                </div>
                <div class="card-body">
        `;
        
        if (modelResult.success && modelResult.recommendations && modelResult.recommendations.length > 0) {
            html += `<div class="row">`;
            
            modelResult.recommendations.forEach((rec, i) => {
                const rankNumber = i + 1;  // â­ ä¿®å¤ï¼šå…ˆè®¡ç®—æ’åæ•°å­—
                html += `
                    <div class="col-lg-2 col-md-3 col-sm-4 col-6 mb-3">
                        <div class="card h-100">
                            <div class="position-relative">
                                <img src="${rec.image_url}" class="card-img-top" alt="${escapeHtml(rec.title)}"
                                     onerror="this.src='/static/images/book-placeholder.png'"
                                     style="height: 200px; object-fit: cover;">
                                <div class="position-absolute top-0 start-0 m-2">
                                    <span class="badge bg-success">#${rankNumber}</span>
                                </div>
                                <div class="position-absolute top-0 end-0 m-2">
                                    <span class="badge badge-score">${rec.score.toFixed(3)}</span>
                                </div>
                            </div>
                            <div class="card-body p-2">
                                <h6 class="card-title small" style="height: 2.5rem; overflow: hidden; line-height: 1.2;">
                                    ${escapeHtml(rec.title.substring(0, 40))}${rec.title.length > 40 ? '...' : ''}
                                </h6>
                                <p class="text-muted small mb-1" style="height: 1.5rem; overflow: hidden;">
                                    ${escapeHtml(rec.author.substring(0, 25))}
                                </p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-warning">
                                        <i class="fas fa-star"></i> ${rec.avg_rating.toFixed(1)}
                                    </small>
                                    <small class="text-muted">${rec.rating_count}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `</div>`;
        } else {
            html += `
                <div class="text-center py-4 text-muted">
                    <i class="fas fa-exclamation-circle fa-2x mb-2"></i>
                    <p>è¯¥æ¨¡å‹æœªè¿”å›æ¨èç»“æœ</p>
                    ${modelResult.error ? `<small class="text-danger">é”™è¯¯: ${escapeHtml(modelResult.error)}</small>` : ''}
                    <small class="d-block mt-2 text-muted">
                        å¯èƒ½åŸå› ï¼šè¯¥å›¾ä¹¦ä¸åœ¨æ­¤æ¨¡å‹çš„è®­ç»ƒæ•°æ®ä¸­
                    </small>
                </div>
            `;
        }
        
        html += `
                </div>
            </div>
        `;
    });
    
    // æ·»åŠ è¯´æ˜
    html += `
        <div class="card bg-light border-0">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-lightbulb me-2"></i>
                    æ¨¡å‹è¯´æ˜
                </h5>
                <ul class="mb-0">
                    <li><strong>ItemBasedCF</strong>: åŸºäºç‰©å“çš„ååŒè¿‡æ»¤ï¼Œæ¨èç”¨æˆ·è¡Œä¸ºç›¸ä¼¼çš„ä¹¦ç±ï¼ˆä¾èµ–è¯„åˆ†çŸ©é˜µï¼‰</li>
                    <li><strong>MatrixFactorization</strong>: çŸ©é˜µåˆ†è§£ç®—æ³•ï¼Œé€šè¿‡éšè¯­ä¹‰æ¨¡å‹å‘ç°æ·±å±‚å…³è”ï¼ˆä¾èµ–è¯„åˆ†çŸ©é˜µï¼‰</li>
                    <li><strong>LightFM</strong>: æ··åˆæ¨èæ¨¡å‹ï¼Œç»“åˆååŒè¿‡æ»¤å’Œå†…å®¹ç‰¹å¾ï¼ˆé²æ£’æ€§æ›´å¥½ï¼‰</li>
                    <li><strong>TwoStage</strong>: ä¸¤é˜¶æ®µæ¶æ„ï¼ˆå¬å›+LightGBMæ’åºï¼‰ï¼Œæ€§èƒ½æœ€ä¼˜ â­</li>
                </ul>
                <div class="alert alert-info mt-3 mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>æ³¨æ„ï¼š</strong>å¦‚æœæŸä¸ªæ¨¡å‹æ— æ¨èç»“æœï¼Œå¯èƒ½æ˜¯å› ä¸ºè¯¥å›¾ä¹¦ä¸åœ¨è¯¥æ¨¡å‹çš„è®­ç»ƒæ•°æ®çŸ©é˜µä¸­ã€‚
                    LightFM å’Œ TwoStage é€šå¸¸è¦†ç›–ç‡æ›´é«˜ã€‚
                </div>
            </div>
        </div>
    `;
    
    resultsSection.innerHTML = html;
}

// HTML è½¬ä¹‰å‡½æ•°
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}